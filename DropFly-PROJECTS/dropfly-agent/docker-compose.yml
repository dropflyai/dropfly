# DropFly Agent — Docker Compose (Full Stack)
#
# Usage:
#   docker compose up -d          # Start everything
#   docker compose logs -f agent  # Follow agent logs
#   docker compose down           # Stop everything

services:
  # ---------------------------------------------------------------
  # DropFly Agent (main application)
  # ---------------------------------------------------------------
  agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dropfly-agent
    restart: unless-stopped
    ports:
      - "${GATEWAY_PORT:-8420}:8420"
    env_file:
      - .env
    environment:
      - GATEWAY_HOST=0.0.0.0
      - GATEWAY_PORT=8420
      - WORKSPACE_ROOT=/app/workspaces
      - SANDBOX_ENABLED=true
      - DOCKER_SANDBOX_IMAGE=dropfly-sandbox:latest
    volumes:
      - workspaces:/app/workspaces
      - /var/run/docker.sock:/var/run/docker.sock  # For Docker sandbox
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8420/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # ---------------------------------------------------------------
  # Sandbox image (pre-built for agent code execution)
  # ---------------------------------------------------------------
  sandbox:
    build:
      context: ./infrastructure/docker
      dockerfile: Dockerfile.sandbox
    image: dropfly-sandbox:latest
    profiles:
      - build-only  # Only built, not run as a service

  # ---------------------------------------------------------------
  # Redis (session cache, rate limiting, pub/sub)
  # ---------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: dropfly-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ---------------------------------------------------------------
  # Channels Bridge (WhatsApp, Telegram, Slack, Discord)
  # ---------------------------------------------------------------
  channels:
    build:
      context: ./channels
      dockerfile: Dockerfile
    container_name: dropfly-channels
    restart: unless-stopped
    ports:
      - "${BRIDGE_PORT:-3420}:3420"
    env_file:
      - ./channels/.env
    environment:
      - GATEWAY_URL=http://agent:8420
      - BRIDGE_PORT=3420
    depends_on:
      agent:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3420/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    profiles:
      - with-channels  # Enable with: docker compose --profile with-channels up
    deploy:
      resources:
        limits:
          memory: 512M

  # ---------------------------------------------------------------
  # Caddy (reverse proxy + auto-HTTPS) — optional
  # ---------------------------------------------------------------
  caddy:
    image: caddy:2-alpine
    container_name: dropfly-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/docker/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - agent
    profiles:
      - with-https  # Only when you want HTTPS

volumes:
  workspaces:
    driver: local
  redis_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local
